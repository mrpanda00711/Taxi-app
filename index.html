<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Taxi & Bus Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d283a 0, #020617 55%, #000 100%);
      color: #e5e7eb;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: #eab308;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-weight: 800;
      font-size: 1.1rem;
      box-shadow: 0 0 24px rgba(234, 179, 8, 0.6);
    }

    .app-title h1 {
      margin: 0;
      font-size: 1.1rem;
    }

    .app-title p {
      margin: 0;
      margin-top: 2px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid #1f2937;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .settings-btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .settings-btn span {
      font-size: 1rem;
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
      backdrop-filter: blur(12px);
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .input-group {
      position: relative;
      margin-bottom: 8px;
    }

    .input-prefix {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      color: #9ca3af;
    }

    input[type="text"] {
      width: 100%;
      padding: 11px 12px 11px 34px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.95rem;
      outline: none;
    }

    input[type="text"]::placeholder {
      color: #6b7280;
    }

    input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
    }

    button {
      width: 100%;
      padding: 11px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 6px;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: linear-gradient(135deg, #facc15, #eab308);
      color: #111827;
      box-shadow: 0 10px 20px rgba(250, 204, 21, 0.45);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #374151;
      box-shadow: none;
      font-size: 0.8rem;
      padding: 7px 10px;
      width: auto;
      margin-top: 4px;
    }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .secondary-text {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .error {
      color: #fca5a5;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .results-header h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .result-line {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 0.9rem;
    }

    .label-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid #374151;
      color: #9ca3af;
    }

    hr {
      border: none;
      border-top: 1px solid #1f2937;
      margin: 8px 0;
    }

    #map {
      width: 100%;
      height: 260px;
      border-radius: 16px;
      overflow: hidden;
    }

    .tarief-row {
      display: grid;
      grid-template-columns: 1.1fr 1fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
    }

    .tarief-row label {
      font-size: 0.7rem;
      margin-bottom: 2px;
    }

    .tarief-row small {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .back-btn {
      width: auto;
      padding-inline: 12px;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    @media (max-width: 360px) {
      .card { padding: 12px; }
      #map { height: 220px; }
      .tarief-row {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>

<body>
<div class="app">

  <header class="app-header">
    <div class="logo-wrap">
      <div class="logo-circle">T</div>
      <div class="app-title">
        <h1>TaxiCalc</h1>
        <p>GPS · start & eindadres</p>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
      <button id="openSettingsBtn" class="settings-btn">
        <span>⚙</span> Tarieven
      </button>
      <span class="badge">
        <span style="width:7px;height:7px;border-radius:999px;background:#22c55e;"></span>
        Live · Google Maps
      </span>
    </div>
  </header>

  <!-- PAGINA: HOOFDSCHERM -->
  <div id="page-main" class="page active">

    <!-- Invoer -->
    <section class="card">
      <label for="startAddress">Startadres</label>
      <div class="input-group">
        <span class="input-prefix">A</span>
        <input
          id="startAddress"
          type="text"
          placeholder="Bijv. De Bruidsbogerd 11, Naaldwijk"
          autocomplete="off"
        />
      </div>
      <div class="btn-row">
        <button type="button" id="useGpsBtn" class="btn-ghost">Gebruik GPS als startpunt</button>
      </div>
      <p id="startInfo" class="secondary-text">Startpunt: handmatig adres.</p>

      <label for="endAddress" style="margin-top:10px;">Eindadres</label>
      <div class="input-group">
        <span class="input-prefix">B</span>
        <input
          id="endAddress"
          type="text"
          placeholder="Bijv. Sint Bartholomeusstraat, Poeldijk"
          autocomplete="off"
        />
      </div>

      <button id="calcBtn" class="btn-primary">Bereken rit automatisch</button>
      <p id="status" class="secondary-text"></p>
      <p id="error" class="error"></p>
      <p class="secondary-text">
        Startadres en eindadres kun je handmatig invoeren, of GPS gebruiken als startpunt.
      </p>
    </section>

    <!-- Resultaten -->
    <section class="card">
      <div class="results-header">
        <h3>Resultaten</h3>
        <span class="label-pill">Live berekend</span>
      </div>

      <div class="result-line">
        <span>Afstand</span>
        <span id="distanceText">-</span>
      </div>

      <div class="result-line">
        <span>Reistijd</span>
        <span id="durationText">-</span>
      </div>

      <hr>

      <div class="result-line" style="margin-top:6px;">
        <span>Taxi (1–4 pers.)</span>
        <span id="taxiTotal">-</span>
      </div>
      <p id="taxiBreakdown" class="secondary-text"></p>

      <div class="result-line" style="margin-top:4px;">
        <span>Bus (5–8 pers.)</span>
        <span id="busTotal">-</span>
      </div>
      <p id="busBreakdown" class="secondary-text"></p>
    </section>

    <!-- Kaart -->
    <section class="card">
      <div id="map"></div>
      <p class="secondary-text" style="margin-top:6px;">
        De route op de kaart komt overeen met de berekende afstand en tijd.
      </p>
    </section>

  </div>

  <!-- PAGINA: TARIeVEN -->
  <div id="page-settings" class="page">

    <button id="backToMainBtn" class="btn-ghost back-btn">← Terug naar rit</button>

    <section class="card">
      <div class="results-header">
        <h3>Tarieven</h3>
        <span class="label-pill" id="tariefStatus">Standaard</span>
      </div>

      <p class="secondary-text" style="margin-bottom:6px;">
        Pas hier je taxi- en bustarieven aan. Ze worden lokaal opgeslagen op dit toestel.
      </p>

      <div class="tarief-row">
        <div>
          <label for="taxiStart">Taxi start</label>
          <input id="taxiStart" type="number" step="0.01">
          <small>€ per rit</small>
        </div>
        <div>
          <label for="taxiKm">Taxi / km</label>
          <input id="taxiKm" type="number" step="0.01">
          <small>€ per km</small>
        </div>
        <div>
          <label for="taxiMin">Taxi / min</label>
          <input id="taxiMin" type="number" step="0.01">
          <small>€ per min</small>
        </div>
      </div>

      <div class="tarief-row">
        <div>
          <label for="busStart">Bus start</label>
          <input id="busStart" type="number" step="0.01">
          <small>€ per rit</small>
        </div>
        <div>
          <label for="busKm">Bus / km</label>
          <input id="busKm" type="number" step="0.01">
          <small>€ per km</small>
        </div>
        <div>
          <label for="busMin">Bus / min</label>
          <input id="busMin" type="number" step="0.01">
          <small>€ per min</small>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" id="resetTariffsBtn" class="btn-ghost">Reset standaard</button>
        <button type="button" id="saveTariffsBtn" class="btn-primary" style="width:auto;padding-inline:14px;">
          Tarieven opslaan
        </button>
      </div>
      <p id="tariefError" class="error"></p>
    </section>

  </div>

</div>

<script>
  // ==== TARIEVEN (worden overschreven vanuit settings / localStorage) ====
  let TAXI_START = 3.60;
  let TAXI_PER_KM = 2.65;
  let TAXI_PER_MIN = 0.44;

  let BUS_START = 7.33;
  let BUS_PER_KM = 3.34;
  let BUS_PER_MIN = 0.49;

  const DEFAULT_TARIFFS = {
    taxiStart: 3.60,
    taxiKm: 2.65,
    taxiMin: 0.44,
    busStart: 7.33,
    busKm: 3.34,
    busMin: 0.49,
  };

  let map;
  let directionsService;
  let directionsRenderer;
  let autocompleteStart;
  let autocompleteEnd;

  // hier onthouden we de geselecteerde places
  let startPlace = null;
  let endPlace = null;

  // true = gebruik GPS als startpunt, false = gebruik startadres
  let useGPSStart = false;

  function euro(v) {
    return "€ " + v.toFixed(2).replace(".", ",");
  }

  function applyTariffs(t) {
    TAXI_START = t.taxiStart;
    TAXI_PER_KM = t.taxiKm;
    TAXI_PER_MIN = t.taxiMin;
    BUS_START = t.busStart;
    BUS_PER_KM = t.busKm;
    BUS_PER_MIN = t.busMin;
  }

  function loadTariffs() {
    const saved = localStorage.getItem("taxiCalcTariffs");
    const fields = {
      taxiStart: document.getElementById("taxiStart"),
      taxiKm: document.getElementById("taxiKm"),
      taxiMin: document.getElementById("taxiMin"),
      busStart: document.getElementById("busStart"),
      busKm: document.getElementById("busKm"),
      busMin: document.getElementById("busMin"),
    };
    const statusLabel = document.getElementById("tariefStatus");

    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        applyTariffs(parsed);
        fields.taxiStart.value = parsed.taxiStart;
        fields.taxiKm.value = parsed.taxiKm;
        fields.taxiMin.value = parsed.taxiMin;
        fields.busStart.value = parsed.busStart;
        fields.busKm.value = parsed.busKm;
        fields.busMin.value = parsed.busMin;
        statusLabel.textContent = "Aangepast";
        return;
      } catch (e) {
        console.warn("Kon opgeslagen tarieven niet lezen", e);
      }
    }

    // geen geldige opslag → defaults
    applyTariffs(DEFAULT_TARIFFS);
    fields.taxiStart.value = DEFAULT_TARIFFS.taxiStart;
    fields.taxiKm.value = DEFAULT_TARIFFS.taxiKm;
    fields.taxiMin.value = DEFAULT_TARIFFS.taxiMin;
    fields.busStart.value = DEFAULT_TARIFFS.busStart;
    fields.busKm.value = DEFAULT_TARIFFS.busKm;
    fields.busMin.value = DEFAULT_TARIFFS.busMin;
    statusLabel.textContent = "Standaard";
  }

  function saveTariffs() {
    const errEl = document.getElementById("tariefError");
    const statusLabel = document.getElementById("tariefStatus");

    const t = {
      taxiStart: parseFloat(document.getElementById("taxiStart").value.replace(",", ".")),
      taxiKm: parseFloat(document.getElementById("taxiKm").value.replace(",", ".")),
      taxiMin: parseFloat(document.getElementById("taxiMin").value.replace(",", ".")),
      busStart: parseFloat(document.getElementById("busStart").value.replace(",", ".")),
      busKm: parseFloat(document.getElementById("busKm").value.replace(",", ".")),
      busMin: parseFloat(document.getElementById("busMin").value.replace(",", ".")),
    };

    if (Object.values(t).some(v => isNaN(v) || v < 0)) {
      errEl.textContent = "Controleer de ingevulde tarieven (geen negatieve of lege waarden).";
      return;
    }

    errEl.textContent = "";
    applyTariffs(t);
    localStorage.setItem("taxiCalcTariffs", JSON.stringify(t));
    statusLabel.textContent = "Aangepast";
  }

  function resetTariffs() {
    localStorage.removeItem("taxiCalcTariffs");
    loadTariffs();
    document.getElementById("tariefError").textContent = "";
  }

  function initAutocomplete() {
    const startInput = document.getElementById("startAddress");
    const endInput = document.getElementById("endAddress");

    autocompleteStart = new google.maps.places.Autocomplete(startInput, {
      fields: ["formatted_address", "geometry"],
      types: ["geocode"]
    });

    autocompleteEnd = new google.maps.places.Autocomplete(endInput, {
      fields: ["formatted_address", "geometry"],
      types: ["geocode"]
    });

    autocompleteStart.addListener("place_changed", () => {
      startPlace = autocompleteStart.getPlace();
      useGPSStart = false;
      document.getElementById("startInfo").textContent =
        "Startpunt: handmatig adres (gekozen uit lijst).";
    });

    autocompleteEnd.addListener("place_changed", () => {
      endPlace = autocompleteEnd.getPlace();
    });

    // Als gebruiker zelf typt, ook handmatige modus
    startInput.addEventListener("input", () => {
      useGPSStart = false;
      startPlace = null; // nieuwe tekst → oude place niet meer relevant
      document.getElementById("startInfo").textContent = "Startpunt: handmatig adres.";
    });
  }

  function initMap() {
    loadTariffs();

    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 52.0, lng: 4.2 },
      zoom: 12,
      disableDefaultUI: true,
      styles: [
        { elementType: "geometry", stylers: [{ color: "#0b1120" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#0b1120" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#9ca3af" }] },
        { featureType: "road", elementType: "geometry", stylers: [{ color: "#1f2937" }] },
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#020617" }] },
        { featureType: "poi", elementType: "labels.icon", stylers: [{ visibility: "off" }] }
      ]
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      map,
      suppressMarkers: false
    });

    initAutocomplete();
  }

  async function calculateRoute() {
    const startInput = document.getElementById("startAddress");
    const endInput = document.getElementById("endAddress");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    const distanceTextEl = document.getElementById("distanceText");
    const durationTextEl = document.getElementById("durationText");
    const taxiTotalEl = document.getElementById("taxiTotal");
    const busTotalEl = document.getElementById("busTotal");
    const taxiBreakdownEl = document.getElementById("taxiBreakdown");
    const busBreakdownEl = document.getElementById("busBreakdown");

    const startAddress = startInput.value.trim();
    const endAddress = endInput.value.trim();

    if (!endAddress) {
      errorEl.textContent = "Vul een eindadres in (of kies een suggestie).";
      return;
    }

    if (!useGPSStart && !startAddress) {
      errorEl.textContent = "Vul een startadres in of gebruik GPS.";
      return;
    }

    errorEl.textContent = "";
    statusEl.textContent = "Route voorbereiden...";

    // ORIGIN bepalen
    let origin;

    if (useGPSStart) {
      statusEl.textContent = "GPS ophalen...";
      let pos;
      try {
        pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
        });
      } catch (e) {
        errorEl.textContent = "GPS fout: " + e.message;
        statusEl.textContent = "";
        return;
      }
      origin = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
    } else {
      if (startPlace && startPlace.geometry && startPlace.geometry.location) {
        origin = startPlace.geometry.location;
      } else {
        origin = startAddress; // tekstadres → Google mag geocoden
      }
    }

    // DESTINATION bepalen
    let destination;
    if (endPlace && endPlace.geometry && endPlace.geometry.location) {
      destination = endPlace.geometry.location;
    } else {
      destination = endAddress;
    }

    statusEl.textContent = "Route berekenen...";

    directionsService.route(
      {
        origin,
        destination,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        if (status !== "OK") {
          errorEl.textContent = "Kan route niet berekenen: " + status;
          statusEl.textContent = "";
          return;
        }

        directionsRenderer.setDirections(result);

        const leg = result.routes[0].legs[0];
        const km = leg.distance.value / 1000;
        const min = leg.duration.value / 60;

        distanceTextEl.textContent = km.toFixed(2) + " km";
        durationTextEl.textContent = min.toFixed(1) + " min";

        const taxi = TAXI_START + km * TAXI_PER_KM + min * TAXI_PER_MIN;
        const bus  = BUS_START  + km * BUS_PER_KM  + min * BUS_PER_MIN;

        taxiTotalEl.textContent = euro(taxi);
        busTotalEl.textContent  = euro(bus);

        taxiBreakdownEl.textContent =
          `Start ${euro(TAXI_START)} · afstand ${euro(km*TAXI_PER_KM)} · tijd ${euro(min*TAXI_PER_MIN)}`;

        busBreakdownEl.textContent =
          `Start ${euro(BUS_START)} · afstand ${euro(km*BUS_PER_KM)} · tijd ${euro(min*BUS_PER_MIN)}`;

        statusEl.textContent = "Klaar ✅";
      }
    );
  }

  function showPage(id) {
    document.getElementById("page-main").classList.remove("active");
    document.getElementById("page-settings").classList.remove("active");
    document.getElementById(id).classList.add("active");
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("calcBtn").addEventListener("click", calculateRoute);

    const useGpsBtn = document.getElementById("useGpsBtn");
    const startInfo = document.getElementById("startInfo");
    const saveTariffsBtn = document.getElementById("saveTariffsBtn");
    const resetTariffsBtn = document.getElementById("resetTariffsBtn");
    const openSettingsBtn = document.getElementById("openSettingsBtn");
    const backToMainBtn = document.getElementById("backToMainBtn");

    useGpsBtn.addEventListener("click", () => {
      useGPSStart = true;
      startPlace = null; // GPS heeft voorrang
      document.getElementById("startAddress").value = "";
      startInfo.textContent = "Startpunt: huidige GPS locatie.";
    });

    saveTariffsBtn.addEventListener("click", saveTariffs);
    resetTariffsBtn.addEventListener("click", resetTariffs);

    openSettingsBtn.addEventListener("click", () => showPage("page-settings"));
    backToMainBtn.addEventListener("click", () => showPage("page-main"));

    // PWA service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(console.error);
    }
  });
</script>

<!-- GOOGLE MAPS + PLACES -->
<script async
        defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARifklpb4qUvHMEPoq_4k2DcPrcVZ9tCU&libraries=places&callback=initMap">
</script>
</body>
</html>